<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>전문가 평가 설문지 (CVI)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .form-radio {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            border-radius: 50%;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #d1d5db;
            transition: 0.2s all linear;
            cursor: pointer;
        }
        .form-radio:checked {
            border: 6px solid #4f46e5;
        }
        .table-header {
            background-color: #f3f4f6;
            font-weight: 700;
        }
        th, td {
            padding: 1rem 0.75rem;
            text-align: center;
            vertical-align: middle;
            border: 1px solid #e5e7eb;
        }
        .question-text {
            text-align: left;
            font-weight: 500;
        }
        .opinion-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            min-width: 120px;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .nav-btn:disabled, .part-btn:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .part-btn-completed {
            background-color: #16a34a;
            color: white;
            border-color: #16a34a;
        }
        .part-btn-completed:hover {
            background-color: #15803d;
        }
        .progress-bar {
            width: 0%;
            transition: width 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-6 md:p-8">

    <div id="main-container" class="max-w-7xl mx-auto bg-white rounded-lg shadow-xl p-6 sm:p-8">
        
        <!-- 시작 안내 및 IRB 동의 페이지 -->
        <div id="consent-page" class="page active">
            <header class="text-center border-b pb-4 mb-8">
                 <h1 class="text-3xl font-bold text-gray-800">문항 타당도 평가 연구 참여 안내 및 동의서</h1>
                 <p class="mt-2 text-gray-500">[연구 기관명] / [IRB 승인 번호: XXX-XXX]</p>
            </header>
            <div class="text-left max-w-4xl mx-auto space-y-6 text-gray-700">
                <p>본 평가는 <strong>[연구/프로젝트 이름]</strong>의 일환으로 개발된 <strong>[측정 대상, 예: 대학생의 공감 능력]</strong> 측정 도구의 내용 타당도를 검증하기 위해 마련되었습니다.</p>
                
                <div>
                    <h3 class="font-bold text-lg mb-2">1. 연구 목적 및 절차</h3>
                    <p>본 연구는 개발된 문항이 본래 측정하고자 하는 개념을 얼마나 충실히 반영하고 있는지 전문가님의 의견을 수렴하여 도구의 질을 향상시키는 것을 목적으로 합니다. 평가는 크게 두 파트로 구성되며, 예상 소요 시간은 약 <strong>[예상 소요 시간, 예: 20-30분]</strong>입니다.</p>
                </div>
                <div>
                    <h3 class="font-bold text-lg mb-2">2. 위험 및 혜택, 보상</h3>
                    <p>본 연구 참여로 인해 예상되는 위험은 없으며, 참여에 대한 직접적인 혜택 또한 없습니다. 다만 전문가님의 소중한 의견은 학문적 발전에 기여할 것입니다. 참여 완료 시 감사의 의미로 소정의 보상(커피 쿠폰)을 지급해 드립니다.</p>
                </div>
                <div>
                    <h3 class="font-bold text-lg mb-2">3. 익명성 보장 및 정보보호</h3>
                    <p>응답 내용은 코드화되어 익명으로 처리되며, 연구 데이터와 보상 발송을 위한 연락처 정보는 물리적/논리적으로 완벽히 분리하여 관리됩니다. 연락처 정보는 보상 발송 즉시 파기되며, 연구 데이터는 관련 법규에 따라 [보관 기간, 예: 3년]간 안전하게 보관 후 파기됩니다. 본 연구 결과는 학술적 목적으로만 사용됩니다.</p>
                </div>
                <div>
                    <h3 class="font-bold text-lg mb-2">4. 참여 및 철회 권리</h3>
                    <p>연구 참여는 자발적이며, 언제든지 동의를 철회하고 평가를 중단할 수 있습니다. 중단으로 인한 어떠한 불이익도 없습니다.</p>
                </div>
                 <div>
                    <h3 class="font-bold text-lg mb-2">5. 문의처</h3>
                    <p>본 연구에 대해 궁금한 점이 있으시면 아래 연락처로 문의 바랍니다.</p>
                    <p class="mt-1 text-sm">책임 연구자: [연구자 이름] ([소속]) / 이메일: [이메일 주소] / 연락처: [전화번호]</p>
                </div>
            </div>
            <div class="mt-10 text-center">
                <p class="mb-4 text-gray-600">위 내용을 모두 확인하였으며, 연구 참여에 자발적으로 동의합니다.</p>
                <button id="consent-btn" class="nav-btn bg-indigo-600 text-white font-bold py-3 px-10 rounded-lg hover:bg-indigo-700 transition-colors duration-300 text-lg">
                    동의 및 평가 시작하기
                </button>
            </div>
        </div>

        <!-- 전문가 정보 입력 페이지 -->
        <div id="panel-info-page" class="page">
             <h1 class="text-3xl font-bold text-gray-800 text-center">전문가 정보 입력</h1>
             <p class="mt-4 text-lg text-gray-600 text-center">원활한 분석을 위해 전문가님의 정보를 입력해주세요.</p>
             <form id="panel-info-form" class="mt-8 max-w-2xl mx-auto space-y-6">
                 <div>
                     <label for="major" class="block text-sm font-medium text-gray-700">전공 분야</label>
                     <input type="text" id="major" name="major" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                 </div>
                 <div>
                     <label for="experience-year" class="block text-sm font-medium text-gray-700">관련 실무/연구 경력 (년수)</label>
                     <input type="number" id="experience-year" name="experience-year" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                 </div>
                 <div>
                     <label for="affiliation" class="block text-sm font-medium text-gray-700">소속 영역 (예: 교육심리, 교육공학, AI)</label>
                     <input type="text" id="affiliation" name="affiliation" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                 </div>
                 <div>
                     <p class="block text-sm font-medium text-gray-700">타당도 검증 참여 경험</p>
                     <div class="mt-2 space-x-4">
                        <label class="inline-flex items-center"><input type="radio" name="validation-exp" value="yes" class="form-radio" required> <span class="ml-2">있음</span></label>
                        <label class="inline-flex items-center"><input type="radio" name="validation-exp" value="no" class="form-radio"> <span class="ml-2">없음</span></label>
                     </div>
                 </div>
                 <div class="text-center pt-6">
                     <button type="submit" class="nav-btn bg-indigo-600 text-white font-bold py-3 px-10 rounded-lg hover:bg-indigo-700">다음</button>
                 </div>
             </form>
        </div>

        <!-- 파트 선택 페이지 -->
        <div id="part-selection-page" class="page text-center">
             <h1 class="text-3xl font-bold text-gray-800">평가 파트 선택</h1>
             <p class="mt-4 text-lg text-gray-600">원하시는 파트를 선택하여 평가를 진행해주세요. (순서 무관)</p>
             <div class="mt-10 flex flex-col md:flex-row justify-center items-center gap-8">
                <button id="start-part1-btn" class="part-btn w-full md:w-80 h-40 text-2xl font-bold border-2 border-indigo-600 text-indigo-600 rounded-lg hover:bg-indigo-50 transition-colors duration-300 flex flex-col justify-center items-center">
                    <span>파트 1</span>
                    <span class="text-lg font-medium mt-2">시나리오 기반 문항 평가</span>
                </button>
                <button id="start-part2-btn" class="part-btn w-full md:w-80 h-40 text-2xl font-bold border-2 border-purple-600 text-purple-600 rounded-lg hover:bg-purple-50 transition-colors duration-300 flex flex-col justify-center items-center">
                    <span>파트 2</span>
                    <span class="text-lg font-medium mt-2">사전/사후 검사 문항 평가</span>
                </button>
             </div>
             <div class="mt-12">
                 <button id="go-to-summary-btn" class="nav-btn bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700 transition-colors duration-300 text-lg" disabled>
                    응답 요약 및 최종 제출 하기
                </button>
                <p class="mt-2 text-sm text-gray-500">※ 두 파트를 모두 완료해야 버튼이 활성화됩니다.</p>
             </div>
        </div>

        <!-- 설문지 본문 (동적 생성) -->
        <main id="survey-container" class="page">
             <div id="progress-bar-container" class="w-full bg-gray-200 rounded-full h-2.5 mb-4" style="display: none;">
                <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full progress-bar"></div>
             </div>
             <form id="evaluationForm">
                <div id="part-header"></div>
                <!-- 평가 안내문 -->
                <details class="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-8 cursor-pointer">
                    <summary class="font-semibold text-lg text-gray-800">평가 안내문 (클릭하여 보기/접기)</summary>
                    <div class="mt-4">
                        <p class="text-gray-700 mb-4">
                            제시된 각 문항에 대해, 내용 타당도, 표현의 명확성, 필요성을 4점 척도로 평가해주십시오. 또한 필요 시 개선 의견을 작성해 주십시오.
                        </p>
                        <h4 class="font-semibold text-gray-800 mb-2">평가 척도 (4점 Likert)</h4>
                        <ul class="list-disc list-inside text-gray-600">
                            <li><strong>1점:</strong> 전혀 그렇지 않다</li>
                            <li><strong>2점:</strong> 다소 그렇지 않다</li>
                            <li><strong>3점:</strong> 그렇다 (타당함)</li>
                            <li><strong>4점:</strong> 매우 그렇다 (매우 타당함)</li>
                        </ul>
                    </div>
                </details>
                <div id="question-container"></div>
                <div id="pagination-controls" class="mt-10 flex justify-between items-center">
                    <button type="button" id="back-to-selection-btn" class="nav-btn bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600">파트 선택으로</button>
                    <span id="page-indicator" class="text-gray-700 font-semibold"></span>
                    <div>
                        <button type="button" id="prev-btn" class="nav-btn bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600">이전</button>
                        <button type="button" id="next-btn" class="nav-btn bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700">다음</button>
                        <button type="submit" id="submit-part-btn" class="bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700" style="display: none;">파트 완료</button>
                    </div>
                </div>
            </form>
        </main>

        <!-- 요약 및 최종 제출 페이지 -->
        <div id="summary-page" class="page"></div>

        <!-- Validation Alert Modal -->
        <div id="alert-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center" style="display: none;">
            <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
                <div class="mt-3 text-center">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">응답 누락 알림</h3>
                    <div class="mt-2 px-7 py-3">
                        <p class="text-sm text-gray-500" id="alert-message"></p>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="close-alert-btn" class="px-4 py-2 bg-indigo-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-300">
                            확인
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        // --- 설정 (Configuration) ---
        const config = {
            instrumentId: 'CVI_Survey_v1', // 연구/측정도구를 식별하는 고유 ID
            evaluationTypes: [
                { key: 'relevance', label: '타당도' },
                { key: 'clarity', label: '명확성' },
                { key: 'necessity', label: '필요성' }
            ],
            likertScale: [1, 2, 3, 4]
        };

        // --- 데이터 ---
        const surveyData = {
            part1: {
                title: "파트 1: 시나리오 기반 문항 평가",
                completed: false,
                pages: [
                    { id: 1, title: '시나리오 1: 사실 오류', text: "세계보건기구(WHO)는 '글로벌 수분 보충 이니셔티브(Global Hydration Initiative)' 보고서를 통해 모든 성인은 신체 기능 유지를 위해 매일 최소 3리터의 물을 섭취하는 것이 절대적으로 필수적이라고 명시하고 있습니다.", questions: [ { id: 1, subFactor: "프레이밍 효과", text: "'절대적/필수적' 같은 표현으로 강력한 사실처럼 포장한다" }, { id: 2, subFactor: "맹신 편향", text: "'WHO'와 가짜 보고서 이름을 내세워 비판 없이 믿게 한다" }, { id: 3, subFactor: "일반화 오류", text: "일부 권장사항을 모든 사람에게 적용한다" }, { id: 4, subFactor: "정박 효과", text: "'3리터'라는 숫자에 판단이 고정된다" } ] },
                    { id: 2, title: '시나리오 2: 인용 오류', text: "스탠포드 대학 연구진이 2023년 'Cognitive Science' 저널에 발표한 논문에 따르면, 5세 이전에 제2외국어에 노출된 아이들은 그렇지 않은 아이들보다 문제 해결 능력이 평균 30% 높게 나타났습니다. (논문 DOI나 링크 없음)", questions: [ { id: 1, subFactor: "맹신 편향", text: "'스탠포드/저널' 등 권위를 이용해 사실처럼 믿게 한다" }, { id: 2, subFactor: "정박 효과", text: "'30%'라는 숫자에 판단이 고정된다" }, { id: 3, subFactor: "프레이밍 효과", text: "그럴듯한 출처를 제시하는 방식으로 신뢰도를 높인다" }, { id: 4, subFactor: "일반화 오류", text: "특정 연구 결과를 모든 아동에게 적용한다" } ] },
                    { id: 3, title: '시나리오 3: 수치 왜곡', text: "자체 데이터 분석팀의 최신 보고서에 따르면, 새로 출시된 'AI 숏폼' 기능의 사용자 참여율이 도입 첫 주 만에 300% 폭증했습니다. 이는 이번 업데이트가 전례 없는 성공을 거두었음을 명백히 보여줍니다.", questions: [ { id: 1, subFactor: "정박 효과", text: "'+300%'라는 극적인 첫 숫자에 생각이 묶여, 업데이트가 엄청난 성공을 거두었다고 판단하게 한다" }, { id: 2, subFactor: "프레이밍 효과", text: "'폭증'이라는 긍정적이고 과장된 표현으로 성공이라는 틀을 씌운다" }, { id: 3, subFactor: "맹신 편향", text: "'자체 데이터 분석팀'이라는 출처에 비판 없이 수용하게 된다" }, { id: 4, subFactor: "일반화 오류", text: "'첫 주'의 성과를 전체의 성공인 것처럼 확대한다" } ] },
                    { id: 4, title: '시나리오 4: 논리 오류', text: "최근 한 기술 블로그(TechDev Journal)에 공유된 비공식 설문조사 결과, 명상을 시작한 개발자 중 80% 이상이 '코딩 집중력이 향상되었다'고 응답했습니다. 따라서 명상은 IT 전문가의 생산성을 높이는 검증된 방법이라고 할 수 있습니다.", questions: [ { id: 1, subFactor: "일반화 오류", text: "'비공식 설문' 결과를 '검증된 방법'이라고 비약한다" }, { id: 2, subFactor: "맹신 편향", text: "'기술 블로그'라는 출처를 인용하여, 주장을 사실처럼 믿게 한다" }, { id: 3, subFactor: "정박 효과", text: "'80%'라는 숫자에 판단이 고정된다" }, { id: 4, subFactor: "프레이밍 효과", text: "개인적인 일화를 통해 설득력있게 포장한다" } ] },
                    { id: 5, title: '시나리오 5: 요약 왜곡', text: "원문: 'A 후보자는 해당 정책이 일부 긍정적 효과를 가질 수 있으나, 재정적 부담과 잠재적 부작용에 대한 추가적인 사회적 합의와 신중한 검토가 선행되어야 한다'며 유보적인 입장을 보였다.'\n\nAI 요약: A 후보자는 해당 정책 도입이 재정적 문제를 야기할 것이라며 강력히 반대했습니다.", questions: [ { id: 1, subFactor: "프레이밍 효과", text: "'강력 반대'라는 부정적 표현으로 인식을 바꾼다" }, { id: 2, subFactor: "맹신 편향", text: "AI가 요약했다는 사실 자체로, 내용이 정확할 것이라는 믿음을 갖게 한다" }, { id: 3, subFactor: "일반화 오류", text: "후보자의 한 가지 발언을 전체 입장으로 확대한다" }, { id: 4, subFactor: "정박 효과", text: "'강력 반대'라는 첫 요약에 판단이 고정된다" } ] },
                    { id: 6, title: '시나리오 6: 개체/시간 오류', text: "애플의 창업자 빌 게이츠는 1984년, 혁신적인 아이팟을 출시하며 '주머니 속의 1000곡'이라는 시대를 열었습니다.", questions: [ { id: 1, subFactor: "맹신 편향", text: "유명한 이름(애플, 빌 게이츠)을 섞어 의심 없이 믿게 한다" }, { id: 2, subFactor: "프레이밍 효과", text: "그럴듯한 이야기 형식으로 정보를 전달해 신뢰를 높인다" }, { id: 3, subFactor: "일반화 오류", text: "빌 게이츠가 IT업계 거물이니 애플도 만들었을 거라 생각한다" }, { id: 4, subFactor: "정박 효과", text: "'1984년'이라는 구체적 연도에 현혹되어 사실로 믿는다" } ] },
                    { id: 7, title: '시나리오 7: 구식 정보', text: "최신 고사양 PC를 맞추기 위한 그래픽 카드를 찾고 계신가요? 현재 시장 상황을 종합 분석한 결과, 엔비디아의 RTX 3080이 가장 합리적인 '성능 대비 가격'을 제공하는 최고의 선택입니다. 4K 게이밍 환경을 완벽하게 지원합니다.", questions: [ { id: 1, subFactor: "일반화 오류", text: "과거의 최고 제품이 '현재'도 최고일 거라 착각하게 한다" }, { id: 2, subFactor: "맹신 편향", text: "AI가 '종합 분석'했다고 표현하여, 추천 내용이 현재에도 유효할 것이라는 믿음을 준다" }, { id: 3, subFactor: "정박 효과", text: "'RTX 3080'이라는 유명 모델명에 판단이 고정된다" }, { id: 4, subFactor: "프레이밍 효과", text: "'최고의 선택'이라는 표현으로 장점만 보게 한다" } ] },
                    { id: 8, title: '시나리오 8: 상호작용 오류', text: "사용자 요청: '기후 변화의 원인에 대한 과학적 합의를 설명하되, '인간 활동'이라는 단어는 사용하지 말고 세 문장으로 요약해줘.'\n\nAI 답변: 기후 변화는 산업 혁명 이후 대기 중 온실가스 농도가 급격히 증가하면서 발생했습니다. 이러한 가스는 지구의 평균 기온을 상승시키는 주된 요인으로 작용합니다. 따라서 인간 활동이 기후 변화의 핵심 원인이라는 점은 명백합니다.", questions: [ { id: 1, subFactor: "맹신 편향", text: "그럴듯한 결과물을 생성해, 제약 조건 준수 여부를 확인하지 않고 믿게 한다" }, { id: 2, subFactor: "프레이밍 효과", text: "답변 내용이 그럴듯해서 제약을 어긴 것을 눈치채지 못한다" }, { id: 3, subFactor: "일반화 오류", text: "AI가 보통은 말을 잘 들으니 이번에도 그랬을 거라 생각한다" }, { id: 4, subFactor: "정박 효과", text: "첫 문장이 요청대로 시작해서 끝까지 확인하지 않는다" } ] }
                ]
            },
            part2: {
                title: "파트 2: 사전/사후 검사 문항 평가",
                completed: false,
                categories: [
                    { id: 1, title: '할루시네이션 유형', questions: [
                        { id: "concept", text: "인지 오류(편향)의 기본 개념을 알고 있다." },
                        { id: "hallucination", text: "할루시네이션의 의미(사실이 아닌 정보를 그럴듯하게 생성)를 알고 있다." },
                        { id: "intervention", text: "생성형 AI 사용 과정에서도 인지 오류가 개입할 수 있음을 알고 있다." },
                        { id: "distinction", text: "AI 답변에서 맹신·일반화·정박·프레이밍 징후를 구분할 수 있다." },
                        { id: "self-awareness", text: "AI를 쓰다가 내 판단에 편향이 끼어드는 순간을 스스로 알아차린 경험이 있다." },
                        { id: "application", text: "편향이 의심되면 교차 검증·숫자 기준/모수 확인·표현 바꿔 읽기 등을 적용할 자신이 있다." },
                        { id: "identification", text: "할루시네이션의 주요 원인/징후(가짜 인용·개체/시간 혼동·수치 왜곡·구식 정보 등)를 사례로 식별할 수 있다." }
                    ]},
                    { id: 2, title: '학습 만족도', questions: [
                        { id: "satisfaction", text: "이번 퀴즈 기반 학습 경험에 전반적으로 만족한다." },
                        { id: "usefulness", text: "이번 활동이 실제 AI 활용에 도움이 될 것 같다." }
                    ]},
                ]
            }
        };

        let currentPart = null;
        let currentPage = 1;
        let sessionData = {}; // 응답을 기억하기 위한 객체

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            window.scrollTo(0,0);
        }

        function showAlert(message) {
            document.getElementById('alert-message').innerHTML = message;
            document.getElementById('alert-modal').style.display = 'flex';
        }

        function renderPart(partKey) {
            currentPart = partKey;
            currentPage = 1;
            const part = surveyData[partKey];
            document.getElementById('part-header').innerHTML = `<h1 class="text-3xl font-bold text-gray-800 mb-8 text-center">${part.title}</h1>`;
            document.getElementById('progress-bar-container').style.display = (partKey === 'part1') ? 'block' : 'none';
            renderQuestionPage();
            showPage('survey-container');
        }

        function renderQuestionPage() {
            const part = surveyData[currentPart];
            const container = document.getElementById('question-container');
            let html = '';
            
            const evaluationTypeHeaders = config.evaluationTypes.map(type => `<th scope="col">${type.label}</th>`).join('');
            const likertScaleHeaders = config.evaluationTypes.map(() => `<th class="font-normal border-x-0"><div class="flex justify-around items-center">${config.likertScale.map(n=>`<span>${n}점</span>`).join('')}</div></th>`).join('');
            const radioButtons = (namePrefix) => config.evaluationTypes.map(type => `<td><div class="flex justify-around items-center">${config.likertScale.map(v => `<label class="cursor-pointer"><input type="radio" class="form-radio" name="${namePrefix}_${type.key}" value="${v}"><span class="sr-only">${v}점</span></label>`).join('')}</div></td>`).join('');

            if (currentPart === 'part1') {
                const pageData = part.pages[currentPage - 1];
                let questionsHtml = pageData.questions.map(q => `
                    <tr>
                        <td class="font-semibold">${q.subFactor}</td>
                        <td class="question-text">${q.text}</td>
                        ${radioButtons(`p1_s${pageData.id}_i${q.id}`)}
                        <td><input type="text" class="opinion-input" name="p1_s${pageData.id}_i${q.id}_opinion" placeholder="모호한 표현, 대체 문구 제안 등"></td>
                    </tr>`).join('');

                html = `<div id="scenario-page-${pageData.id}">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4 p-3 bg-gray-50 rounded-md">${pageData.title}</h3>
                    <div class="bg-white p-4 border rounded-md mb-6 whitespace-pre-wrap"><p class="text-gray-700 leading-relaxed">${pageData.text}</p></div>
                    <div class="overflow-x-auto mb-8 bg-gray-50 p-4 rounded-lg">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3 text-left pl-1">※ 시나리오 자체 평가</h4>
                        <table class="min-w-full border-collapse bg-white">
                            <thead class="table-header">
                                 <tr><th scope="col" rowspan="2">평가 대상</th>${evaluationTypeHeaders}<th scope="col" rowspan="2">의견</th></tr>
                                 <tr class="text-sm text-gray-600">${likertScaleHeaders}</tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="font-semibold bg-gray-50">${pageData.title}</td>
                                    ${radioButtons(`p1_s${pageData.id}_scenario`)}
                                    <td><input type="text" class="opinion-input" name="p1_s${pageData.id}_scenario_opinion" placeholder="시나리오 개선 의견"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="overflow-x-auto">
                         <h4 class="text-lg font-semibold text-gray-800 mb-3 text-left pl-1">※ 개별 문항 평가</h4>
                        <table class="min-w-full border-collapse">
                            <thead class="table-header">
                                 <tr><th scope="col" rowspan="2">하위 요소</th><th scope="col" rowspan="2">문항</th>${evaluationTypeHeaders}<th scope="col" rowspan="2">의견</th></tr>
                                 <tr class="text-sm text-gray-600">${likertScaleHeaders}</tr>
                            </thead>
                            <tbody>${questionsHtml}</tbody>
                        </table>
                    </div>
                </div>`;
            } else {
                part.categories.forEach(category => {
                    let questionsHtml = category.questions.map(q => `
                        <tr>
                            <td class="question-text">${q.text}</td>
                            ${radioButtons(`p2_c${category.id}_i'${q.id}'`)}
                            <td><input type="text" class="opinion-input" name="p2_c${category.id}_i'${q.id}'_opinion" placeholder="모호한 표현, 대체 문구 제안 등"></td>
                        </tr>`).join('');
                    
                    html += `<div id="prepost-category-${category.id}" class="mb-10">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4 p-3 bg-gray-50 rounded-md">구성요인: ${category.title}</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full border-collapse">
                                <thead class="table-header">
                                    <tr><th scope="col" rowspan="2">문항</th>${evaluationTypeHeaders}<th scope="col" rowspan="2">의견</th></tr>
                                    <tr class="text-sm text-gray-600">${likertScaleHeaders}</tr>
                                </thead>
                                <tbody>${questionsHtml}</tbody>
                            </table>
                        </div>
                    </div>`;
                });
            }
            container.innerHTML = html;
            repopulateForm();
            updatePaginationControls();
        }

        function updateSessionData() {
            const formData = new FormData(document.getElementById('evaluationForm'));
            for(const [key, value] of formData.entries()) {
                sessionData[key] = value;
            }
        }

        function repopulateForm() {
            const form = document.getElementById('evaluationForm');
            form.querySelectorAll('input').forEach(input => {
                const value = sessionData[input.name];
                if(value) {
                    if(input.type === 'radio') {
                        if(input.value === value) {
                            input.checked = true;
                        }
                    } else {
                        input.value = value;
                    }
                }
            });
        }
        
        function updatePaginationControls() {
            const part = surveyData[currentPart];
            const pageIndicator = document.getElementById('page-indicator');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const submitPartBtn = document.getElementById('submit-part-btn');
            const progressBar = document.getElementById('progress-bar');

            if (currentPart === 'part1') {
                const totalPages = part.pages.length;
                pageIndicator.textContent = `페이지 ${currentPage} / ${totalPages}`;
                pageIndicator.style.display = 'inline-block';
                prevBtn.style.display = 'inline-block';
                nextBtn.style.display = currentPage === totalPages ? 'none' : 'inline-block';
                submitPartBtn.style.display = currentPage === totalPages ? 'inline-block' : 'none';
                prevBtn.disabled = currentPage === 1;
                progressBar.style.width = `${(currentPage / totalPages) * 100}%`;
            } else {
                pageIndicator.style.display = 'none';
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
                submitPartBtn.style.display = 'inline-block';
            }
        }
        
        function validateCurrentPage() {
            const container = document.getElementById('question-container');
            const radioGroups = new Map();
            container.querySelectorAll('input[type="radio"]').forEach(radio => {
                if (!radioGroups.has(radio.name)) {
                    const row = radio.closest('tr');
                    const questionText = row ? row.querySelector('.question-text, .font-semibold')?.textContent.trim() : `항목`;
                    radioGroups.set(radio.name, { answered: false, label: questionText });
                }
            });

            for (const name of radioGroups.keys()) {
                if (document.querySelector(`form#evaluationForm input[name="${name}"]:checked`)) {
                    radioGroups.get(name).answered = true;
                }
            }
            
            const unanswered = [];
            for (const [name, data] of radioGroups.entries()) {
                if (!data.answered) {
                    let questionType = '';
                    for (const type of config.evaluationTypes) {
                        if (name.includes(type.key)) {
                            questionType = type.label;
                            break;
                        }
                    }
                    unanswered.push(`'${data.label}'의 <strong>${questionType}</strong>`);
                }
            }
            return unanswered;
        }

        function displaySummary(data) {
            const summaryData = {};
            ['p1_scenario', 'p1_item', 'p2_item'].forEach(part => {
                summaryData[part] = {};
                config.evaluationTypes.forEach(type => summaryData[part][type.key] = []);
            });

            for (const key in data.responses) {
                const val = parseInt(data.responses[key]);
                if (isNaN(val)) continue;
                
                const keyParts = key.split('_');
                const partPrefix = keyParts[0]; // p1 or p2
                const itemType = key.includes('_scenario_') ? 'scenario' : 'item';
                const fullPartKey = `${partPrefix}_${itemType}`;

                if (summaryData[fullPartKey]) {
                    for (const type of config.evaluationTypes) {
                        if (key.endsWith(type.key)) {
                            summaryData[fullPartKey][type.key].push(val);
                            break;
                        }
                    }
                }
            }

            const calculateAvg = (arr) => arr.length ? (arr.reduce((a, b) => a + b, 0) / arr.length).toFixed(2) : 'N/A';
            
            const p1_scenario_avg = {}, p1_item_avg = {}, p2_item_avg = {};
            config.evaluationTypes.forEach(type => {
                p1_scenario_avg[type.key] = calculateAvg(summaryData.p1_scenario[type.key]);
                p1_item_avg[type.key] = calculateAvg(summaryData.p1_item[type.key]);
                p2_item_avg[type.key] = calculateAvg(summaryData.p2_item[type.key]);
            });
            
            const generateSummaryList = (avgData, color) => config.evaluationTypes.map(type => 
                `<li class="flex justify-between"><span>${type.label}:</span> <span class="font-bold text-${color}-600">${avgData[type.key]} / 4.00</span></li>`
            ).join('');
            
            const summaryContainer = document.getElementById('summary-page');
            summaryContainer.innerHTML = `
                <div class="text-center">
                    <h2 class="text-2xl font-bold text-gray-800">응답 요약 및 최종 제출</h2>
                    <p class="mt-4 text-gray-600">아래 요약은 전문가님의 개인 응답에 대한 미리보기입니다. 최종 I-CVI, S-CVI 등의 타당도 지수는 모든 전문가 패널의 응답을 종합하여 산출될 예정입니다.</p>
                </div>
                <div class="mt-10 grid md:grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-blue-50 p-6 rounded-lg border border-blue-200">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">파트 1: 시나리오 평가 요약</h3>
                        <div class="mt-4"><h4 class="font-semibold text-gray-700">시나리오 자체 평가 (평균)</h4><ul class="space-y-2 text-gray-700 mt-2">${generateSummaryList(p1_scenario_avg, 'blue')}</ul></div>
                        <div class="mt-6 pt-4 border-t"><h4 class="font-semibold text-gray-700">개별 문항 평가 (평균)</h4><ul class="space-y-2 text-gray-700 mt-2">${generateSummaryList(p1_item_avg, 'blue')}</ul></div>
                    </div>
                    <div class="bg-purple-50 p-6 rounded-lg border border-purple-200">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">파트 2: 사전/사후 검사 평가 요약</h3>
                        <div class="mt-4"><h4 class="font-semibold text-gray-700">개별 문항 평가 (평균)</h4><ul class="space-y-2 text-gray-700 mt-2">${generateSummaryList(p2_item_avg, 'purple')}</ul></div>
                    </div>
                </div>
                 <div class="mt-10 pt-8 border-t"><h3 class="text-xl font-bold text-gray-800 mb-4 text-center">전체 설문에 대한 종합 의견 (선택사항)</h3><p class="text-center text-gray-600 mb-4">평가 문항 전반에 대한 의견이나 기타 제언이 있으시다면 자유롭게 남겨주세요.</p><div class="max-w-4xl mx-auto"><textarea id="overall-opinion" name="overall-opinion" rows="4" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" placeholder="종합 의견을 입력해주세요..."></textarea></div></div>
                 <div class="mt-10 pt-8 border-t">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">개인정보 수집 및 이용 안내</h3>
                    <div class="text-sm text-gray-600 max-w-3xl mx-auto bg-gray-50 p-4 rounded border">
                        <p><strong>수집 목적:</strong> 연구 참여 보상(커피 쿠폰) 발송</p>
                        <p><strong>수집 항목:</strong> 휴대전화 번호</p>
                        <p><strong>보유 및 이용기간:</strong> 보상 발송 완료 후 즉시 파기</p>
                        <p class="mt-2">연락처 정보는 연구 데이터와 완전히 분리되어 저장 및 관리됩니다. 정보 제공은 자발적이며, 원치 않으실 경우 입력하지 않으셔도 됩니다. 동의 철회를 원하시면 언제든지 연구자에게 연락주시기 바랍니다.</p>
                    </div>
                    <div class="max-w-sm mx-auto mt-4">
                        <label for="contact-info" class="block text-sm font-medium text-gray-700">연락처 (휴대전화 번호)</label>
                        <input type="tel" id="contact-info" name="contact-info" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm" placeholder="'-' 없이 숫자만 입력해주세요">
                    </div>
                </div>
                <div class="text-center mt-12 flex justify-center gap-4">
                    <button id="back-to-selection-final-btn" class="nav-btn bg-gray-500 text-white font-bold py-3 px-8 rounded-lg hover:bg-gray-600">수정하기</button>
                    <button id="final-submit-btn" class="nav-btn bg-green-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-green-700">설문 최종 제출하기</button>
                </div>
            `;
        }

        function showThankYouMessage() {
            const container = document.getElementById('main-container');
            container.innerHTML = `
                <div class="text-center py-12">
                    <h2 class="text-3xl font-bold text-gray-800">설문이 성공적으로 제출되었습니다.</h2>
                    <p class="mt-4 text-lg text-gray-600">참여해주셔서 대단히 감사합니다. 전문가님의 소중한 의견은 연구에 큰 도움이 될 것입니다.</p>
                    <p class="mt-2 text-sm text-gray-500">이제 이 창을 닫으셔도 좋습니다. 브라우저의 '뒤로 가기'로 재제출하실 수 없습니다.</p>
                </div>`;
        }
        
        function collectAllData() {
            const panelInfoForm = new FormData(document.getElementById('panel-info-form'));
            const data = { 
                instrumentId: config.instrumentId,
                respondentId: `expert_${new Date().getTime()}`, 
                createdAt: new Date().toISOString(),
                panelInfo: {
                    major: panelInfoForm.get('major'),
                    experienceYear: panelInfoForm.get('experience-year'),
                    affiliation: panelInfoForm.get('affiliation'),
                    validationExp: panelInfoForm.get('validation-exp'),
                },
                responses: { ...sessionData }
            };
            return data;
        }

        async function saveToFirebase(data) {
            console.log("Submitting to Firebase:", data);
            return new Promise(resolve => setTimeout(() => resolve(true), 500));
        }

        document.addEventListener('DOMContentLoaded', () => {
            const mainContainer = document.getElementById('main-container');
            
            mainContainer.addEventListener('click', async (event) => {
                const target = event.target.closest('button');
                if (!target) return;

                switch (target.id) {
                    case 'consent-btn':
                        showPage('panel-info-page');
                        break;
                    case 'start-part1-btn':
                        renderPart('part1');
                        break;
                    case 'start-part2-btn':
                        renderPart('part2');
                        break;
                    case 'back-to-selection-btn':
                        updateSessionData();
                        showPage('part-selection-page');
                        break;
                    case 'next-btn': {
                        const unanswered = validateCurrentPage();
                        if (unanswered.length > 0) {
                            showAlert(`다음 항목의 응답을 완료해주세요:<br><ul class="list-disc list-inside mt-2 text-left">${unanswered.map(u => `<li>${u}</li>`).join('')}</ul>`);
                            return;
                        }
                        updateSessionData();
                        if (currentPart === 'part1' && currentPage < surveyData[currentPart].pages.length) {
                            currentPage++;
                            renderQuestionPage();
                        }
                        break;
                    }
                    case 'prev-btn':
                        updateSessionData();
                        if (currentPart === 'part1' && currentPage > 1) {
                            currentPage--;
                            renderQuestionPage();
                        }
                        break;
                    case 'go-to-summary-btn':
                        collectedData = collectAllData();
                        displaySummary(collectedData);
                        showPage('summary-page');
                        break;
                    case 'back-to-selection-final-btn':
                        document.getElementById('start-part1-btn').disabled = false;
                        document.getElementById('start-part2-btn').disabled = false;
                        showPage('part-selection-page');
                        break;
                    case 'final-submit-btn': {
                        const contactInfo = document.getElementById('contact-info').value;
                        if (!contactInfo) {
                            alert('커피 쿠폰 발송을 위해 연락처를 입력해주세요.');
                            return;
                        }
                        const overallOpinion = document.getElementById('overall-opinion').value;
                        collectedData.contactInfo = contactInfo;
                        collectedData.overallOpinion = overallOpinion;
                        
                        target.disabled = true;
                        target.textContent = '제출 중...';

                        const success = await saveToFirebase(collectedData);
                        if (success) {
                            showThankYouMessage();
                        } else {
                            alert('제출 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.');
                            target.disabled = false;
                            target.textContent = '설문 최종 제출하기';
                        }
                        break;
                    }
                    case 'close-alert-btn':
                         document.getElementById('alert-modal').style.display = 'none';
                        break;
                }
            });
            
            mainContainer.addEventListener('submit', (event) => {
                 event.preventDefault();
                 if(event.target.id === 'panel-info-form') {
                     showPage('part-selection-page');
                 } else if (event.target.id === 'evaluationForm') {
                     const unanswered = validateCurrentPage();
                    if (unanswered.length > 0) {
                        showAlert(`다음 항목의 응답을 완료해주세요:<br><ul class="list-disc list-inside mt-2 text-left">${unanswered.map(u => `<li>${u}</li>`).join('')}</ul>`);
                        return;
                    }
                    updateSessionData();
                    surveyData[currentPart].completed = true;
                    const btn = document.getElementById(`start-${currentPart}-btn`);
                    btn.classList.add('part-btn-completed');
                    btn.disabled = true;
                    if (!btn.querySelector('.completion-text')) {
                        btn.innerHTML += '<span class="completion-text text-sm font-normal mt-1">(완료)</span>';
                    }
                    if(surveyData.part1.completed && surveyData.part2.completed) {
                        document.getElementById('go-to-summary-btn').disabled = false;
                    }
                    showPage('part-selection-page');
                 }
            });
        });
    </script>
</body>
</html>

